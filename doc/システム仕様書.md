# カラーサイズメンテナンスツール システム仕様書

## 1. システム概要

### 1.1 目的
現在手作業で行っているカラー・サイズ情報のメンテナンス作業を自動化し、作業効率を向上させる。

### 1.2 対象業務
- 商品データからカラー・サイズ情報を抽出
- 変換表に基づく自動変換処理
- 変換できない項目の手動設定
- tm9030color、tm9035sizeテーブルへのデータ登録

### 1.3 技術スタック
- **フレームワーク**: Python + Streamlit
- **データベース接続**: SQLAlchemy + pyodbc (SQLServer) + PyMySQL (MariaDB)
- **ローカルDB**: SQLite (変換表管理)
- **パッケージング**: PyInstaller

## 2. 機能要件

### 2.1 データ取得機能
- **対象期間指定**: 登録日による商品データの絞り込み
- **データベース接続**: SQLServer、MariaDBへの接続設定
- **商品データ表示**: 取得した商品一覧の表示
- **フィルタリング**: HEAD値による商品の絞り込み

### 2.2 変換処理機能
- **自動変換**: 変換表に基づくカラー・サイズIDの自動設定
- **変換ルール適用**: 
  - カラー: レッド → 1
  - サイズ: 12.0cm → 1
  - 複合値: S/ローズ → サイズID/カラーID
- **変換結果表示**: 変換前後の値を比較表示
- **エラーハンドリング**: 変換できない項目の識別

### 2.3 手動設定機能
- **個別設定**: 変換できない項目の手動ID設定
- **一括設定**: 同じ値を持つ項目の一括設定
- **設定確認**: 手動設定内容の確認・修正

### 2.4 変換表管理機能
- **変換ルール登録**: 新しいカラー・サイズの変換ルール追加
- **変換ルール編集**: 既存ルールの修正
- **変換ルール削除**: 不要なルールの削除
- **変換履歴**: 変換実行履歴の表示

### 2.5 データ登録機能
- **登録前確認**: 登録対象データの最終確認
- **トランザクション処理**: データ整合性の保証
- **登録結果表示**: 成功・失敗件数の表示
- **ロールバック**: エラー時の処理取り消し

## 3. 非機能要件

### 3.1 性能要件
- **データ取得**: 1000件の商品データを30秒以内で取得
- **変換処理**: 1000件の変換処理を60秒以内で完了
- **データ登録**: 1000件の登録処理を120秒以内で完了

### 3.2 可用性要件
- **動作環境**: Windows 11
- **起動時間**: アプリケーション起動から操作開始まで10秒以内
- **エラー復旧**: データベース接続エラー時の自動再接続

### 3.3 保守性要件
- **ログ出力**: 全ての操作ログをファイル出力
- **設定管理**: 外部設定ファイルによる設定変更
- **エラーメッセージ**: 分かりやすい日本語エラーメッセージ

## 4. データベース設計

### 4.1 外部データベース
- **SQLServer**: T410商品テーブル
- **MariaDB**: tm0110goods_group、tm9030color、tm9035sizeテーブル

### 4.2 ローカルデータベース (SQLite)
```sql
-- カラー変換表
CREATE TABLE color_mapping (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    color_name TEXT NOT NULL UNIQUE,
    color_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- サイズ変換表
CREATE TABLE size_mapping (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    size_name TEXT NOT NULL UNIQUE,
    size_id INTEGER NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 変換履歴
CREATE TABLE conversion_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    product_cd TEXT NOT NULL,
    web_cd TEXT NOT NULL,
    original_content TEXT,
    converted_color_id INTEGER,
    converted_size_id INTEGER,
    conversion_type TEXT, -- 'auto' or 'manual'
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## 5. 画面設計

### 5.1 メイン画面
- **ナビゲーション**: サイドバーによる画面遷移
- **ステータス表示**: 現在の処理状況表示
- **ログ表示**: 最新の操作ログ表示

### 5.2 データ取得画面
- **期間指定**: カレンダーによる期間選択
- **接続設定**: データベース接続情報の設定
- **商品一覧**: テーブル形式での商品データ表示
- **フィルタ**: HEAD値による絞り込み

### 5.3 変換処理画面
- **変換対象表示**: 変換対象商品の一覧
- **変換結果表示**: 変換前後の比較表示
- **手動設定**: 変換できない項目の手動設定
- **一括操作**: 選択項目の一括変換

### 5.4 変換表管理画面
- **変換ルール一覧**: 現在の変換ルール表示
- **ルール編集**: 新規追加・編集・削除
- **履歴表示**: 変換実行履歴

### 5.5 データ登録画面
- **登録対象確認**: 登録予定データの表示
- **実行ボタン**: データ登録の実行
- **結果表示**: 登録結果の詳細表示

## 6. セキュリティ要件

### 6.1 データベース接続
- **接続情報暗号化**: データベース接続情報の暗号化保存
- **接続タイムアウト**: 接続タイムアウトの設定
- **権限管理**: 必要最小限のデータベース権限

### 6.2 データ保護
- **バックアップ**: 変換表データの自動バックアップ
- **ログ管理**: 操作ログの適切な管理
- **エラーハンドリング**: 機密情報の漏洩防止

## 7. 運用要件

### 7.1 インストール・配布
- **実行ファイル**: PyInstallerによる単一実行ファイル
- **依存関係**: 必要なライブラリの自動インストール
- **設定ファイル**: 初期設定ファイルの提供

### 7.2 バックアップ・復旧
- **設定バックアップ**: 変換表データの定期バックアップ
- **ログローテーション**: ログファイルの自動ローテーション
- **復旧手順**: 障害時の復旧手順書

## 8. 制約事項

### 8.1 技術制約
- **Windows専用**: Windows 11環境でのみ動作
- **ローカル実行**: サーバー環境不要
- **単一ユーザー**: 同時実行ユーザー1名

### 8.2 業務制約
- **データベース権限**: 既存データベースの権限に依存
- **変換ルール**: 既存の変換ルールに準拠
- **作業時間**: 業務時間内での利用を想定

