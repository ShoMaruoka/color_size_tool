# カラーサイズメンテナンスツール プロジェクト構成詳細

## 1. ディレクトリ構成

```
color_size_tool/
├── main.py                           # メインアプリケーション（Streamlitエントリーポイント）
├── requirements.txt                  # Python依存関係
├── config.yaml                      # アプリケーション設定ファイル
├── .env                             # 環境変数（データベース接続情報等）
├── .gitignore                       # Git除外ファイル
├── README.md                        # プロジェクト説明書
├── setup.py                         # パッケージ設定
├── run.bat                          # Windows起動スクリプト
├── run.sh                           # Linux起動スクリプト
│
├── config/                          # 設定関連モジュール
│   ├── __init__.py
│   ├── database.py                  # データベース接続設定
│   ├── settings.py                  # アプリケーション設定
│   ├── logging_config.py            # ログ設定
│   └── constants.py                 # 定数定義
│
├── models/                          # データモデル
│   ├── __init__.py
│   ├── base.py                      # ベースモデル
│   ├── product.py                   # 商品モデル
│   ├── color.py                     # カラーモデル
│   ├── size.py                      # サイズモデル
│   ├── conversion.py                # 変換履歴モデル
│   └── mapping.py                   # 変換表モデル
│
├── services/                        # ビジネスロジック
│   ├── __init__.py
│   ├── database_service.py          # データベース操作サービス
│   ├── data_service.py              # データ取得サービス
│   ├── conversion_service.py        # 変換処理サービス
│   ├── insert_service.py            # データ登録サービス
│   ├── mapping_service.py           # 変換表管理サービス
│   └── validation_service.py        # バリデーションサービス
│
├── pages/                           # Streamlitページ
│   ├── __init__.py
│   ├── 01_🏠_ホーム.py              # ホームページ
│   ├── 02_📊_データ取得.py          # データ取得ページ
│   ├── 03_🔄_変換処理.py            # 変換処理ページ
│   ├── 04_📋_変換表管理.py          # 変換表管理ページ
│   ├── 05_💾_データ登録.py          # データ登録ページ
│   └── 06_📈_履歴・ログ.py          # 履歴・ログページ
│
├── components/                      # 再利用可能なUIコンポーネント
│   ├── __init__.py
│   ├── database_connection.py       # データベース接続コンポーネント
│   ├── data_table.py                # データテーブルコンポーネント
│   ├── conversion_form.py           # 変換フォームコンポーネント
│   ├── mapping_table.py             # 変換表コンポーネント
│   └── status_display.py            # ステータス表示コンポーネント
│
├── utils/                           # ユーティリティ
│   ├── __init__.py
│   ├── validators.py                # バリデーション関数
│   ├── formatters.py                # フォーマッター関数
│   ├── helpers.py                   # ヘルパー関数
│   ├── exceptions.py                # カスタム例外
│   └── decorators.py                # デコレーター
│
├── data/                            # データファイル
│   ├── conversion.db                # SQLite変換表データベース
│   ├── sample_data/                 # サンプルデータ
│   │   ├── sample_products.csv
│   │   ├── sample_colors.csv
│   │   └── sample_sizes.csv
│   └── backups/                     # バックアップファイル
│       └── conversion_backup_YYYYMMDD.db
│
├── logs/                            # ログファイル
│   ├── app.log                      # アプリケーションログ
│   ├── error.log                    # エラーログ
│   ├── conversion.log               # 変換処理ログ
│   └── archive/                     # アーカイブログ
│       └── app_YYYYMMDD.log
│
├── docs/                            # ドキュメント
│   ├── システム仕様書.md
│   ├── 実装計画書.md
│   ├── プロジェクト構成詳細.md
│   ├── 操作マニュアル.md
│   ├── インストール手順書.md
│   ├── トラブルシューティングガイド.md
│   └── API仕様書.md
│
├── tests/                           # テストコード
│   ├── __init__.py
│   ├── conftest.py                  # pytest設定
│   ├── test_models.py               # モデルテスト
│   ├── test_services.py             # サービステスト
│   ├── test_utils.py                # ユーティリティテスト
│   ├── test_integration.py          # 統合テスト
│   └── fixtures/                    # テストフィクスチャ
│       ├── sample_data.json
│       └── test_db.db
│
├── scripts/                         # スクリプト
│   ├── setup_database.py            # データベース初期化
│   ├── import_sample_data.py        # サンプルデータインポート
│   ├── backup_database.py           # データベースバックアップ
│   └── build_executable.py          # 実行ファイルビルド
│
└── dist/                            # 配布ファイル
    ├── color_size_tool.exe          # Windows実行ファイル
    ├── color_size_tool               # Linux実行ファイル
    ├── config.yaml                  # 設定ファイル
    └── README.txt                   # 配布用説明書
```

## 2. 主要ファイル詳細

### 2.1 main.py
```python
"""
カラーサイズメンテナンスツール メインアプリケーション
"""
import streamlit as st
from config.settings import AppConfig
from config.logging_config import setup_logging

def main():
    """メインアプリケーション"""
    # 設定初期化
    config = AppConfig()
    
    # ログ設定
    setup_logging()
    
    # ページ設定
    st.set_page_config(
        page_title="カラーサイズメンテナンスツール",
        page_icon="🎨",
        layout="wide",
        initial_sidebar_state="expanded"
    )
    
    # サイドバーナビゲーション
    with st.sidebar:
        st.title("🎨 カラーサイズメンテナンスツール")
        st.markdown("---")
        
        # ナビゲーションメニュー
        pages = {
            "🏠 ホーム": "pages/01_🏠_ホーム.py",
            "📊 データ取得": "pages/02_📊_データ取得.py",
            "🔄 変換処理": "pages/03_🔄_変換処理.py",
            "📋 変換表管理": "pages/04_📋_変換表管理.py",
            "💾 データ登録": "pages/05_💾_データ登録.py",
            "📈 履歴・ログ": "pages/06_📈_履歴・ログ.py"
        }
        
        selected_page = st.selectbox("ページを選択", list(pages.keys()))
        
        # ページ実行
        if selected_page:
            exec(open(pages[selected_page]).read())

if __name__ == "__main__":
    main()
```

### 2.2 requirements.txt
```txt
# Webフレームワーク
streamlit==1.28.1
streamlit-option-menu==0.3.6

# データベース
sqlalchemy==2.0.23
pyodbc==5.0.1
pymysql==1.1.0

# データ処理
pandas==2.1.3
numpy==1.25.2

# 設定管理
pyyaml==6.0.1
python-dotenv==1.0.0

# ログ
loguru==0.7.2

# テスト
pytest==7.4.3
pytest-cov==4.1.0

# 開発ツール
black==23.11.0
flake8==6.1.0
mypy==1.7.1

# パッケージング
pyinstaller==6.1.0
```

### 2.3 config.yaml
```yaml
# アプリケーション設定
app:
  name: "カラーサイズメンテナンスツール"
  version: "1.0.0"
  debug: false

# データベース設定
database:
  sqlserver:
    driver: "ODBC Driver 17 for SQL Server"
    server: "localhost"
    database: "your_database"
    trusted_connection: true
    timeout: 30
  
  mariadb:
    host: "localhost"
    port: 3306
    user: "your_user"
    password: "your_password"
    database: "your_database"
    charset: "utf8mb4"
    timeout: 30
  
  sqlite:
    path: "data/conversion.db"
    timeout: 30

# ログ設定
logging:
  level: "INFO"
  format: "{time:YYYY-MM-DD HH:mm:ss} | {level} | {name}:{function}:{line} | {message}"
  rotation: "1 day"
  retention: "30 days"
  compression: "zip"

# 変換設定
conversion:
  batch_size: 100
  max_retries: 3
  retry_delay: 1

# UI設定
ui:
  page_size: 50
  max_file_size: 10MB
  theme: "light"
```

### 2.4 .env
```env
# データベース接続情報（本番環境用）
SQLSERVER_SERVER=your_sqlserver_host
SQLSERVER_DATABASE=your_database_name
SQLSERVER_USER=your_username
SQLSERVER_PASSWORD=your_password

MARIADB_HOST=your_mariadb_host
MARIADB_PORT=3306
MARIADB_DATABASE=your_database_name
MARIADB_USER=your_username
MARIADB_PASSWORD=your_password

# アプリケーション設定
APP_DEBUG=false
LOG_LEVEL=INFO
```

## 3. モジュール詳細

### 3.1 モデル層（models/）

#### 3.1.1 base.py
```python
"""ベースモデル"""
from sqlalchemy.ext.declarative import declarative_base
from sqlalchemy import Column, Integer, DateTime
from datetime import datetime

Base = declarative_base()

class BaseModel(Base):
    """ベースモデルクラス"""
    __abstract__ = True
    
    id = Column(Integer, primary_key=True, autoincrement=True)
    created_at = Column(DateTime, default=datetime.now)
    updated_at = Column(DateTime, default=datetime.now, onupdate=datetime.now)
```

#### 3.1.2 product.py
```python
"""商品モデル"""
from sqlalchemy import Column, String, Integer, Date
from .base import BaseModel

class Product(BaseModel):
    """商品モデル"""
    __tablename__ = 'products'
    
    product_cd = Column(String(50), nullable=False, comment='商品コード')
    product_name = Column(String(200), nullable=False, comment='商品名')
    specification = Column(String(200), comment='規格')
    web_cd = Column(String(50), nullable=False, comment='Webコード')
    head = Column(String(100), comment='HEAD')
    content = Column(String(200), comment='CONTENT')
    registration_date = Column(Date, comment='登録日')
    web_sales = Column(Integer, default=0, comment='WEB販売')
```

### 3.2 サービス層（services/）

#### 3.2.1 database_service.py
```python
"""データベース操作サービス"""
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from config.database import DatabaseConfig
from utils.exceptions import DatabaseConnectionError

class DatabaseService:
    """データベース操作サービス"""
    
    def __init__(self):
        self.config = DatabaseConfig()
        self.engines = {}
        self.sessions = {}
    
    def get_sqlserver_engine(self):
        """SQLServerエンジン取得"""
        if 'sqlserver' not in self.engines:
            try:
                connection_string = self.config.get_sqlserver_connection_string()
                self.engines['sqlserver'] = create_engine(connection_string)
            except Exception as e:
                raise DatabaseConnectionError(f"SQLServer接続エラー: {e}")
        return self.engines['sqlserver']
    
    def get_mariadb_engine(self):
        """MariaDBエンジン取得"""
        if 'mariadb' not in self.engines:
            try:
                connection_string = self.config.get_mariadb_connection_string()
                self.engines['mariadb'] = create_engine(connection_string)
            except Exception as e:
                raise DatabaseConnectionError(f"MariaDB接続エラー: {e}")
        return self.engines['mariadb']
```

### 3.3 ページ層（pages/）

#### 3.3.1 02_📊_データ取得.py
```python
"""データ取得ページ"""
import streamlit as st
from services.data_service import DataService
from components.database_connection import DatabaseConnectionComponent
from components.data_table import DataTableComponent

def main():
    """データ取得ページメイン"""
    st.title("📊 データ取得")
    
    # データベース接続設定
    with st.expander("🔗 データベース接続設定", expanded=True):
        db_component = DatabaseConnectionComponent()
        connection_status = db_component.render()
    
    if connection_status:
        # データ取得設定
        with st.expander("📅 取得条件設定", expanded=True):
            col1, col2 = st.columns(2)
            with col1:
                start_date = st.date_input("開始日", value=datetime(2024, 12, 1))
            with col2:
                end_date = st.date_input("終了日", value=datetime(2024, 12, 31))
        
        # データ取得実行
        if st.button("📥 データ取得実行", type="primary"):
            with st.spinner("データを取得中..."):
                data_service = DataService()
                products = data_service.get_products(start_date, end_date)
                
                if products:
                    st.success(f"✅ {len(products)}件のデータを取得しました")
                    
                    # データ表示
                    table_component = DataTableComponent()
                    table_component.render(products)
                else:
                    st.warning("⚠️ 取得できるデータがありません")

if __name__ == "__main__":
    main()
```

## 4. 設定管理

### 4.1 環境別設定
- **開発環境**: `config/dev.yaml`
- **テスト環境**: `config/test.yaml`
- **本番環境**: `config/prod.yaml`

### 4.2 設定の優先順位
1. 環境変数（.env）
2. 設定ファイル（config.yaml）
3. デフォルト値

## 5. ログ管理

### 5.1 ログレベル
- **DEBUG**: デバッグ情報
- **INFO**: 一般的な情報
- **WARNING**: 警告
- **ERROR**: エラー
- **CRITICAL**: 致命的エラー

### 5.2 ログファイル
- **app.log**: アプリケーション全体のログ
- **error.log**: エラーログのみ
- **conversion.log**: 変換処理専用ログ

## 6. テスト戦略

### 6.1 テスト種類
- **単体テスト**: 各モジュールのテスト
- **結合テスト**: モジュール間の連携テスト
- **統合テスト**: 全体システムのテスト
- **UIテスト**: Streamlitページのテスト

### 6.2 テスト実行
```bash
# 全テスト実行
pytest

# カバレッジ付きテスト
pytest --cov=.

# 特定のテスト実行
pytest tests/test_services.py
```

## 7. デプロイメント

### 7.1 開発環境
```bash
# 仮想環境作成
python -m venv venv
venv\Scripts\activate

# 依存関係インストール
pip install -r requirements.txt

# アプリケーション起動
streamlit run main.py
```

### 7.2 本番環境
```bash
# 実行ファイル作成
pyinstaller --onefile --windowed main.py

# 配布ファイル作成
python scripts/build_executable.py
```

